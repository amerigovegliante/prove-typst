name: Spellcheck Typst Files

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  spellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install aspell and dictionaries
        run: |
          sudo apt-get update
          sudo apt-get install -y aspell aspell-en aspell-it

      - name: Create combined dictionary
        run: |
          # Export English words
          aspell -d en dump master | aspell -l en expand > /tmp/en_words.txt
          # Export Italian words
          aspell -d it dump master | aspell -l it expand > /tmp/it_words.txt
          # Combine dictionaries
          cat /tmp/en_words.txt /tmp/it_words.txt | sort -u > /tmp/word_list.txt
          
          # Add custom words if custom dictionary exists
          if [ -f ".aspell.custom.pws" ]; then
            echo "Found custom dictionary, adding words..."
            # Skip the first line (header) and add custom words
            tail -n +2 .aspell.custom.pws >> /tmp/word_list.txt
            sort -u /tmp/word_list.txt -o /tmp/word_list.txt
          fi
          
          # Create proper aspell personal dictionary format
          WORD_COUNT=$(wc -l < /tmp/word_list.txt)
          echo "personal_ws-1.1 en $WORD_COUNT utf-8" > /tmp/combined_dict.txt
          cat /tmp/word_list.txt >> /tmp/combined_dict.txt

      - name: Spellcheck Typst files
        run: |
          # Find all .typ files
          TYPST_FILES=$(find . -name "*.typ")
          
          if [ -z "$TYPST_FILES" ]; then
            echo "No .typ files found"
            exit 0
          fi
          
          ERRORS_FOUND=0
          
          for file in $TYPST_FILES; do
            echo "Checking: $file"
            
            # Extract text content (remove Typst markup for better checking)
            # This basic extraction removes common Typst syntax
            cat "$file" | \
              sed 's/#[a-zA-Z_][a-zA-Z0-9_]*//g' | \
              sed 's/\[//g' | sed 's/\]//g' | \
              sed 's/{//g' | sed 's/}//g' | \
              aspell list --personal=/tmp/combined_dict.txt --encoding=utf-8 | \
              sort -u > /tmp/misspelled_${file//\//_}.txt
            
            if [ -s /tmp/misspelled_${file//\//_}.txt ]; then
              echo "❌ Potential misspellings in $file:"
              cat /tmp/misspelled_${file//\//_}.txt | sed 's/^/  - /'
              ERRORS_FOUND=1
            else
              echo "✓ No misspellings found in $file"
            fi
            echo ""
          done
          
          if [ $ERRORS_FOUND -eq 1 ]; then
            echo "⚠️  Spellcheck found potential issues. Please review the words above."
            echo "Note: These may include technical terms, proper nouns, or Typst syntax."
            exit 1
          else
            echo "✅ All files passed spellcheck!"
          fi
